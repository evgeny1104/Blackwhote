<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ЧБ Конвертер</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-transparent flex items-center justify-center min-h-screen p-4">

    <!-- Widget Container -->
    <div class="w-full max-w-xl bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden font-sans">
        
        <!-- Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-neutral-900 rounded flex items-center justify-center text-white text-xs font-bold">
                    bw
                </div>
                <div class="text-base font-bold text-neutral-800">ЧБ Фильтр</div>
            </div>
            <button id="closeBtn" class="text-gray-400 hover:text-red-500 transition-colors hidden" title="Сбросить">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 12"/></svg>
            </button>
        </div>

        <!-- Content -->
        <div class="p-4">
            <!-- Error Message -->
            <div id="errorMsg" class="hidden mb-4 p-3 text-sm text-red-700 bg-red-50 rounded-lg border border-red-100"></div>

            <!-- Upload View -->
            <div id="uploadView" class="relative border-2 border-dashed border-gray-200 rounded-xl p-8 flex flex-col items-center justify-center text-center hover:bg-gray-50 hover:border-gray-300 transition-all cursor-pointer select-none">
                <input type="file" id="fileInput" class="hidden" accept="image/png, image/jpeg, image/webp">
                
                <svg class="w-10 h-10 text-gray-300 mb-3" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                
                <p class="text-sm font-medium text-neutral-700 mb-1">Нажмите или перетащите фото</p>
                <p class="text-xs text-gray-400">JPG, PNG или WebP</p>
            </div>

            <!-- Processing/Result View -->
            <div id="resultView" class="hidden flex flex-col gap-4">
                <div class="relative w-full bg-gray-50 rounded-lg overflow-hidden border border-gray-100 flex items-center justify-center min-h-[200px] max-h-[60vh]">
                    <!-- Image -->
                    <img id="previewImage" class="max-w-full max-h-full object-contain" alt="Result">
                    
                    <!-- Loading Overlay -->
                    <div id="loadingOverlay" class="absolute inset-0 bg-white/90 flex items-center justify-center z-10 hidden">
                        <div class="flex flex-col items-center gap-2">
                            <div class="w-6 h-6 border-2 border-neutral-900 border-t-transparent rounded-full spinner"></div>
                            <span class="text-xs text-neutral-500">Обработка...</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="downloadBtn" class="flex-1 bg-neutral-900 text-white hover:bg-neutral-800 inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:ring-offset-1">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Скачать результат
                    </button>
                    <button id="resetBtn" class="flex-1 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-200">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"/><path d="M3 3v9h9"/></svg>
                        Загрузить другое
                    </button>
                </div>
                
                <div class="text-center">
                    <span class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded-full">
                        Обработка происходит локально в браузере
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        (function() {
            // Elements
            const uploadView = document.getElementById('uploadView');
            const resultView = document.getElementById('resultView');
            const fileInput = document.getElementById('fileInput');
            const previewImage = document.getElementById('previewImage');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const errorMsg = document.getElementById('errorMsg');
            const downloadBtn = document.getElementById('downloadBtn');
            const resetBtn = document.getElementById('resetBtn');
            const closeBtn = document.getElementById('closeBtn');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            let currentFileName = 'image';
            let currentImageUrl = null;

            // Event Listeners
            uploadView.addEventListener('click', () => fileInput.click());
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadView.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadView.addEventListener(eventName, () => uploadView.classList.add('bg-gray-50', 'border-neutral-400'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadView.addEventListener(eventName, () => uploadView.classList.remove('bg-gray-50', 'border-neutral-400'), false);
            });

            uploadView.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', handleFileSelect, false);
            resetBtn.addEventListener('click', resetApp);
            closeBtn.addEventListener('click', resetApp);
            downloadBtn.addEventListener('click', downloadImage);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (!file.type.startsWith('image/')) {
                        showError('Пожалуйста, загрузите изображение (JPG, PNG, WebP).');
                        return;
                    }
                    // 15MB Limit
                    if (file.size > 15 * 1024 * 1024) {
                        showError('Файл слишком большой (макс 15 МБ).');
                        return;
                    }
                    
                    currentFileName = file.name.replace(/\.[^/.]+$/, "");
                    processFile(file);
                }
            }

            function showError(msg) {
                errorMsg.textContent = msg;
                errorMsg.classList.remove('hidden');
                // Hide error after 4 seconds
                setTimeout(() => {
                    errorMsg.classList.add('hidden');
                }, 4000);
            }

            function processFile(file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = function() {
                    const img = new Image();
                    img.src = reader.result;
                    
                    // Transition UI
                    errorMsg.classList.add('hidden');
                    uploadView.classList.add('hidden');
                    resultView.classList.remove('hidden');
                    closeBtn.classList.remove('hidden');
                    
                    // Show loading
                    loadingOverlay.classList.remove('hidden');
                    // Temporary show original to hold space
                    previewImage.src = reader.result; 
                    
                    img.onload = function() {
                        // Process Image with slight delay to ensure UI updates
                        setTimeout(() => {
                            try {
                                canvas.width = img.naturalWidth;
                                canvas.height = img.naturalHeight;
                                ctx.drawImage(img, 0, 0);
                                
                                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                const data = imageData.data;
                                
                                // Grayscale Logic (Luminosity)
                                for (let i = 0; i < data.length; i += 4) {
                                    const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                                    data[i] = gray;
                                    data[i + 1] = gray;
                                    data[i + 2] = gray;
                                }
                                
                                ctx.putImageData(imageData, 0, 0);
                                
                                // Export quality 0.85 (balanced)
                                currentImageUrl = canvas.toDataURL('image/jpeg', 0.85);
                                previewImage.src = currentImageUrl;
                            } catch (e) {
                                console.error(e);
                                showError("Ошибка обработки. Возможно файл поврежден.");
                            } finally {
                                loadingOverlay.classList.add('hidden');
                            }
                        }, 50);
                    }
                    
                    img.onerror = function() {
                        showError("Не удалось прочитать изображение.");
                        resetApp();
                    }
                }
            }

            function resetApp() {
                fileInput.value = '';
                currentImageUrl = null;
                uploadView.classList.remove('hidden');
                resultView.classList.add('hidden');
                closeBtn.classList.add('hidden');
                errorMsg.classList.add('hidden');
                previewImage.src = '';
            }

            function downloadImage() {
                if (!currentImageUrl) return;
                const link = document.createElement('a');
                link.download = `${currentFileName}_bw.jpg`;
                link.href = currentImageUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        })();
    </script>
</body>
</html>